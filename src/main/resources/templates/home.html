<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JasperReports Development Tool</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        <header>
            <h1>JasperReports Development Tool</h1>
            <p class="subtitle">Select a report to run</p>
        </header>

        <main>
            <section class="reports-section">
                <div class="section-header">
                    <h2>Available Reports</h2>
                    <button type="button" class="btn btn-secondary" onclick="refreshReports()">
                        Refresh List
                    </button>
                </div>

                <div th:if="${#lists.isEmpty(reports)}" class="empty-state">
                    <p>No reports found.</p>
                    <p class="hint">Add JRXML files to <code>src/main/resources/reports/</code></p>
                </div>

                <ul class="report-list" th:unless="${#lists.isEmpty(reports)}">
                    <li th:each="report : ${reports}" class="report-item" th:data-filename="${report.fileName}">
                        <a th:href="@{/report/{id}(id=${report.id})}" class="report-link">
                            <span class="report-name" th:text="${report.displayName}">Report Name</span>
                            <span class="report-meta">
                                <span th:text="${#lists.size(report.parameters)} + ' parameter(s)'">0 parameters</span>
                                <span class="separator">|</span>
                                <span th:text="${report.fileName}">filename.jrxml</span>
                            </span>
                        </a>
                        <button type="button" class="btn btn-small btn-danger delete-report-btn" th:data-filename="${report.fileName}">Delete</button>
                    </li>
                </ul>
            </section>

            <section class="upload-section" id="uploadSection">
                <h2>Upload Report</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="dropZone">
                        <input type="file" id="fileInput" name="file" accept=".jrxml" style="display: none;">
                        <p class="upload-text">Drag &amp; drop a .jrxml file here, or <button type="button" class="btn-link" onclick="document.getElementById('fileInput').click()">browse</button></p>
                        <p class="upload-hint" id="uploadHint">Uploads disabled - REPORTS_PATH not configured</p>
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <span class="upload-status">Uploading...</span>
                    </div>
                </form>
            </section>

            <section class="images-section" id="imagesSection">
                <h2>Report Images</h2>
                <form id="imageUploadForm" enctype="multipart/form-data">
                    <div class="upload-area upload-area-small" id="imageDropZone">
                        <input type="file" id="imageFileInput" name="file" accept=".png,.jpg,.jpeg,.gif" style="display: none;">
                        <p class="upload-text">Drag &amp; drop an image, or <button type="button" class="btn-link" onclick="document.getElementById('imageFileInput').click()">browse</button></p>
                    </div>
                </form>
                <div id="imagesList" class="images-list">
                    <p class="empty-state">No images uploaded</p>
                </div>
                <p class="hint" id="imagesHint">Use <code>$P{IMAGES_DIR} + "filename.png"</code> in your reports</p>
            </section>

            <section class="datasources-section">
                <h2>Data Sources</h2>
                <div th:if="${#lists.isEmpty(dataSources)}" class="empty-state">
                    <p>No data sources configured.</p>
                    <p class="hint">Edit <code>datasources.properties</code> to add connections.</p>
                </div>
                <ul class="datasource-list" th:unless="${#lists.isEmpty(dataSources)}">
                    <li th:each="ds : ${dataSources}" class="datasource-item" th:data-ds="${ds}">
                        <span class="ds-name" th:text="${ds}">datasource</span>
                        <button type="button" class="btn btn-small test-btn">
                            Test
                        </button>
                        <span class="ds-status"></span>
                    </li>
                </ul>
            </section>
        </main>

        <footer>
            <p>JasperReports Development Tool</p>
        </footer>
    </div>

    <script>
        function refreshReports() {
            fetch('/api/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                })
                .catch(err => alert('Error refreshing: ' + err));
        }

        function deleteReport(fileName) {
            if (!confirm('Delete report: ' + fileName + '?\n\nNote: Only uploaded reports can be deleted, not bundled ones.')) return;

            fetch('/api/reports/' + encodeURIComponent(fileName), { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Delete failed: ' + data.error);
                    }
                })
                .catch(err => alert('Delete error: ' + err));
        }

        function uploadFile(file) {
            const progress = document.getElementById('uploadProgress');
            const dropZone = document.getElementById('dropZone');

            progress.style.display = 'block';
            dropZone.classList.add('uploading');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/reports/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                progress.style.display = 'none';
                dropZone.classList.remove('uploading');

                if (data.success) {
                    location.reload();
                } else {
                    alert('Upload failed: ' + data.error);
                }
            })
            .catch(err => {
                progress.style.display = 'none';
                dropZone.classList.remove('uploading');
                alert('Upload error: ' + err);
            });
        }

        function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/images/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderImagesList(data.images);
                } else {
                    alert('Upload failed: ' + data.error);
                }
            })
            .catch(err => alert('Upload error: ' + err));
        }

        function deleteImage(fileName) {
            if (!confirm('Delete image: ' + fileName + '?')) return;

            fetch('/api/images/' + encodeURIComponent(fileName), { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderImagesList(data.images);
                    } else {
                        alert('Delete failed: ' + data.error);
                    }
                })
                .catch(err => alert('Delete error: ' + err));
        }

        function renderImagesList(images) {
            const container = document.getElementById('imagesList');
            if (!images || images.length === 0) {
                container.innerHTML = '<p class="empty-state">No images uploaded</p>';
                return;
            }

            let html = '<ul class="image-list">';
            images.forEach(img => {
                html += '<li class="image-item">' +
                    '<span class="image-name">' + img + '</span>' +
                    '<button type="button" class="btn btn-small btn-danger" onclick="deleteImage(\'' + img + '\')">Delete</button>' +
                    '</li>';
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // Check upload status and setup handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Check if uploads are enabled
            fetch('/api/reports/upload-status')
                .then(response => response.json())
                .then(data => {
                    const uploadSection = document.getElementById('uploadSection');
                    const uploadHint = document.getElementById('uploadHint');
                    const dropZone = document.getElementById('dropZone');

                    if (data.enabled) {
                        uploadHint.textContent = 'Directory: ' + data.directory;
                        uploadHint.className = 'upload-hint enabled';
                        dropZone.classList.add('enabled');
                    } else {
                        dropZone.classList.add('disabled');
                    }
                });

            // Load images list
            fetch('/api/images')
                .then(response => response.json())
                .then(data => {
                    renderImagesList(data.images);
                    const imageDropZone = document.getElementById('imageDropZone');
                    if (data.directory) {
                        imageDropZone.classList.add('enabled');
                    } else {
                        imageDropZone.classList.add('disabled');
                    }
                });

            // Delete report button handlers
            document.querySelectorAll('.delete-report-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const fileName = this.dataset.filename;
                    deleteReport(fileName);
                });
            });

            // File input change handler
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    uploadFile(this.files[0]);
                }
            });

            // Drag and drop handlers for reports
            const dropZone = document.getElementById('dropZone');

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                this.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');

                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.endsWith('.jrxml')) {
                        uploadFile(file);
                    } else {
                        alert('Please upload a .jrxml file');
                    }
                }
            });

            // Image upload handlers
            document.getElementById('imageFileInput').addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    uploadImage(this.files[0]);
                    this.value = '';
                }
            });

            const imageDropZone = document.getElementById('imageDropZone');

            imageDropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            imageDropZone.addEventListener('dragleave', function(e) {
                this.classList.remove('dragover');
            });

            imageDropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');

                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    const ext = file.name.toLowerCase().split('.').pop();
                    if (['png', 'jpg', 'jpeg', 'gif'].includes(ext)) {
                        uploadImage(file);
                    } else {
                        alert('Please upload an image file (png, jpg, jpeg, gif)');
                    }
                }
            });

            // Attach click handlers to test buttons
            document.querySelectorAll('.test-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const li = this.closest('.datasource-item');
                    const name = li.dataset.ds;
                    const statusEl = li.querySelector('.ds-status');

                    statusEl.textContent = 'Testing...';
                    statusEl.className = 'ds-status testing';

                    fetch('/api/datasource/' + encodeURIComponent(name) + '/test')
                        .then(response => response.json())
                        .then(data => {
                            if (data.connected) {
                                statusEl.textContent = 'Connected';
                                statusEl.className = 'ds-status connected';
                            } else {
                                statusEl.textContent = 'Failed';
                                statusEl.className = 'ds-status failed';
                            }
                        })
                        .catch(err => {
                            statusEl.textContent = 'Error';
                            statusEl.className = 'ds-status failed';
                        });
                });
            });
        });
    </script>
</body>
</html>
